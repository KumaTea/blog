<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Linux on 酷玛阁 | KumaTea's Blog</title><link>https://blog.kmtea.eu/tags/linux/</link><description>Recent content in Linux on 酷玛阁 | KumaTea's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 04 Dec 2023 01:00:00 +0800</lastBuildDate><atom:link href="https://blog.kmtea.eu/tags/linux/index.xml" rel="self" type="application/rss+xml"/><item><title>制作 RHEL LXC 容器镜像</title><link>https://blog.kmtea.eu/p/231204-rhel-lxc/</link><pubDate>Mon, 04 Dec 2023 01:00:00 +0800</pubDate><guid>https://blog.kmtea.eu/p/231204-rhel-lxc/</guid><description>&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/cover.jpg" alt="Featured image of post 制作 RHEL LXC 容器镜像" /&gt;&lt;h1 id="制作-rhel-lxc-容器镜像"&gt;制作 RHEL LXC 容器镜像
&lt;/h1&gt;&lt;h2 id="前言"&gt;前言
&lt;/h2&gt;&lt;p&gt;虽然玩 Linux 很多年了，但一直以来都只是用
Debian 系的发行版，对其他的没有涉猎。
最近发现了 LXC 的美妙之处，于是试了试一直没体验过的 RHEL。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;鲁迅先生说过，中国人的性情是总喜欢调和折中的。&lt;/p&gt;
&lt;p&gt;作为硬件级的虚拟，VM 太过笨重，对内存的利用效率太低；
而作为应用级的虚拟，Docker 又太过轻量，systemd 也不能用，
只能用来部署单一程序。相比之下，作为系统级虚拟的 LXC
就是日常调试的最佳选择。&lt;/p&gt;
&lt;h2 id="踩坑"&gt;踩坑
&lt;/h2&gt;&lt;p&gt;我首先尝试的是官方 docker 镜像
&lt;a class="link" href="https://catalog.redhat.com/software/containers/ubi9/ubi/615bcf606feffc5384e8452e" target="_blank" rel="noopener"
&gt;ubi (Universal Base Image)&lt;/a&gt;,
通过 &lt;code&gt;docker save&lt;/code&gt; 导出后直接导入到 PVE 中。
虽然可以启动，但是缺少太多组件，出现大量恶性问题，如无法联网等，不具备可用性。&lt;/p&gt;
&lt;p&gt;然后尝试了去年试过的 &lt;a class="link" href="https://blog.kmtea.eu/p/220710-pi-rhel/" target="_blank" rel="noopener"
&gt;转生大法&lt;/a&gt;,
不过 &lt;code&gt;convert2rhel&lt;/code&gt; 至今不支持 RHEL 9, 因此作罢。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;然而，ubi 的文件结构是我们的重要参考，
后续我们打包的 rootfs 要力求与之一致。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/00-ubi.jpg"
width="1940"
height="893"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/00-ubi_hu_ae6a6e9ffce4eb5c.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/00-ubi_hu_bda5c4ebacda8f12.jpg 1024w"
loading="lazy"
alt="rootfs"
class="gallery-image"
data-flex-grow="217"
data-flex-basis="521px"
&gt;&lt;/p&gt;
&lt;h2 id="准备"&gt;准备
&lt;/h2&gt;&lt;p&gt;打开 ISO &lt;a class="link" href="https://developers.redhat.com/products/rhel/download" target="_blank" rel="noopener"
&gt;下载官网&lt;/a&gt;,
&lt;strong&gt;拉到下面&lt;/strong&gt;，选择 &lt;strong&gt;Boot iso&lt;/strong&gt; 下载。&lt;del&gt;当然你财力雄厚也可以选择十几G的 DVD iso&lt;/del&gt;&lt;/p&gt;
&lt;h2 id="提取"&gt;提取
&lt;/h2&gt;&lt;p&gt;这一步要从 RHEL 完整虚拟机中提取 rootfs。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-01.jpg"
width="2089"
height="1253"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-01_hu_dbaf003e20128165.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-01_hu_5fe1cbdce960430e.jpg 1024w"
loading="lazy"
alt="install"
class="gallery-image"
data-flex-grow="166"
data-flex-basis="400px"
&gt;&lt;/p&gt;
&lt;p&gt;进入右上角，安装盘选择&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-02.jpg"
width="993"
height="902"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-02_hu_d0b407e8cecd6c85.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-02_hu_bc6816545fffe566.jpg 1024w"
loading="lazy"
alt="destination"
class="gallery-image"
data-flex-grow="110"
data-flex-basis="264px"
&gt;&lt;/p&gt;
&lt;p&gt;下面选择自定义 Custom，否则它要给你创建 LVM 了&lt;/p&gt;
&lt;p&gt;点击一次 Done 后，出来如下界面&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-03.jpg"
width="1089"
height="754"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-03_hu_2814e699b3f15dc0.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-03_hu_ac94366708c2fd7.jpg 1024w"
loading="lazy"
alt="custom"
class="gallery-image"
data-flex-grow="144"
data-flex-basis="346px"
&gt;&lt;/p&gt;
&lt;p&gt;选择标准分区 Standard Partition，然后点击上方蓝字
Click here to create them automatically&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-04.jpg"
width="1361"
height="943"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-04_hu_b9fa3a3c806eaa9a.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-04_hu_68a4ac3a5c04c65d.jpg 1024w"
loading="lazy"
alt="partition"
class="gallery-image"
data-flex-grow="144"
data-flex-basis="346px"
&gt;&lt;/p&gt;
&lt;p&gt;这里直接 Done 就行，但保险起见我把文件系统设为了 ext4&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;中间需要登录&lt;/p&gt;
&lt;p&gt;登录后下方选择安装内容&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-05.jpg"
width="2024"
height="1247"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-05_hu_7823d8f8a3c65119.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-05_hu_1fca3e55e9b82288.jpg 1024w"
loading="lazy"
alt="software"
class="gallery-image"
data-flex-grow="162"
data-flex-basis="389px"
&gt;&lt;/p&gt;
&lt;p&gt;左边选择 Minimal Install，右边什么都不选&lt;/p&gt;
&lt;p&gt;左下设置 root 密码就可以开始安装了&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;安装完成后，重启进入系统。
建议 ssh, vnc 没法复制粘贴，属于灾难级的体验。
然后执行&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;yum install -y tar
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir afs boot dev home lost+found media mnt opt proc root run srv sys tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chmod -R &lt;span class="m"&gt;777&lt;/span&gt; tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chown -R nobody:nobody proc sys
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;cp -a /bin /etc /lib /lib64 /sbin /usr /var .
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rm -rf var/log/* var/cache/* var/tmp/*
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;tar cvJf rootfs.tar.xz ./*
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;生成 &lt;code&gt;rootfs.tar.xz&lt;/code&gt; 后，任选方式传到 PVE 上。&lt;/p&gt;
&lt;p&gt;我喜欢用 &lt;code&gt;python3 -m http.server 8080&lt;/code&gt;，
但是要记得先关防火墙 &lt;code&gt;systemctl stop firewalld&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-06.jpg"
width="897"
height="365"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-06_hu_9740bec84a9677fc.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/01-inst-06_hu_fd7bfeea518cae63.jpg 1024w"
loading="lazy"
alt="uploaded"
class="gallery-image"
data-flex-grow="245"
data-flex-basis="589px"
&gt;&lt;/p&gt;
&lt;h2 id="精简"&gt;精简
&lt;/h2&gt;&lt;p&gt;LXC 运行环境下，固件、内核均由宿主机提供，
我们可以将其卸载，节省空间。&lt;/p&gt;
&lt;p&gt;由 &lt;code&gt;rootfs.tar.xz&lt;/code&gt; 创建 lxc，启动后进入 shell&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# dnf list --installed | grep firmware&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# dnf list --installed | grep kernel&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;dnf remove -y iwl100-firmware.noarch iwl1000-firmware.noarch iwl105-firmware.noarch iwl135-firmware.noarch iwl2000-firmware.noarch iwl2030-firmware.noarch iwl3160-firmware.noarch iwl5000-firmware.noarch iwl5150-firmware.noarch iwl6000g2a-firmware.noarch iwl6050-firmware.noarch iwl7260-firmware.noarch linux-firmware.noarch linux-firmware-whence.noarch
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;dnf remove -y kernel.x86_64 kernel-core.x86_64 kernel-modules.x86_64 kernel-modules-core.x86_64 kernel-tools.x86_64 kernel-tools-libs.x86_64
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;dnf remove -y microcode_ctl
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;dnf clean all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;一举节省高达一半空间&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/02-slim-01.jpg"
width="1835"
height="973"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/02-slim-01_hu_932bbf116c99492f.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/02-slim-01_hu_e16bb2eb156b0ab1.jpg 1024w"
loading="lazy"
alt="uninstall"
class="gallery-image"
data-flex-grow="188"
data-flex-basis="452px"
&gt;&lt;/p&gt;
&lt;p&gt;接下来是清除不必要的语言包，100M左右&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /usr/share/locale
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /tmp/locale
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mv en* locale.alias /tmp/locale/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rm -rf ./*
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mv /tmp/locale/* .
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rmdir /tmp/locale
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;可以考虑关闭在容器中无法运行的服务&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;dnf remove -y audit
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;systemctl disable chronyd.service
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;最终体积来到 500M 左右，与官方 templates 同一水平。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/02-slim-02.jpg"
width="1026"
height="378"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/02-slim-02_hu_340673f8981ae549.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/02-slim-02_hu_4890e03f8c496e4f.jpg 1024w"
loading="lazy"
alt="df"
class="gallery-image"
data-flex-grow="271"
data-flex-basis="651px"
&gt;&lt;/p&gt;
&lt;p&gt;最后和上一步一样打包即可。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir afs boot dev home lost+found media mnt opt proc root run srv sys tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chmod -R &lt;span class="m"&gt;777&lt;/span&gt; tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chown -R nobody:nobody proc sys
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;cp -a /bin /etc /lib /lib64 /sbin /usr /var .
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rm -rf var/log/* var/cache/* var/tmp/*
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;tar cvJf rhel-9-minimal_9.3_amd64.tar.xz ./*
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id="后记"&gt;后记
&lt;/h2&gt;&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231204-rhel-lxc/img/03-info-01.jpg"
width="1828"
height="924"
srcset="https://blog.kmtea.eu/p/231204-rhel-lxc/img/03-info-01_hu_d04f1b1247badf35.jpg 480w, https://blog.kmtea.eu/p/231204-rhel-lxc/img/03-info-01_hu_6c3b679af12ad235.jpg 1024w"
loading="lazy"
alt="info"
class="gallery-image"
data-flex-grow="197"
data-flex-basis="474px"
&gt;&lt;/p&gt;
&lt;p&gt;有几点提醒：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;如果导入后启动，内存占用极低，终端黑屏无显示，可能是误删了 /etc 下账户文件
可通过 &lt;code&gt;lxc-start -n &amp;lt;ctid&amp;gt; -F -l DEBUG&lt;/code&gt; 接入调试。&lt;/li&gt;
&lt;li&gt;非常不建议分享你制作的镜像！
首先 &lt;code&gt;subscription-manager unregister&lt;/code&gt; 不能保证账户信息完全被抹除，
其次 &lt;code&gt;/etc&lt;/code&gt; 下 &lt;code&gt;fstab&lt;/code&gt; &lt;code&gt;hosts&lt;/code&gt; &lt;code&gt;hostname&lt;/code&gt; &lt;code&gt;resolv.conf&lt;/code&gt; &lt;code&gt;shadow&lt;/code&gt; 等大量文件均可能包含敏感信息。&lt;/li&gt;
&lt;/ol&gt;</description></item></channel></rss>