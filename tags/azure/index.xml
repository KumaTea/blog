<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure on 酷玛阁 | KumaTea's Blog</title><link>https://blog.kmtea.eu/tags/azure/</link><description>Recent content in Azure on 酷玛阁 | KumaTea's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sat, 14 Oct 2023 02:30:58 +0800</lastBuildDate><atom:link href="https://blog.kmtea.eu/tags/azure/index.xml" rel="self" type="application/rss+xml"/><item><title>SaaS 平台 Python 应用部署实战</title><link>https://blog.kmtea.eu/p/231013-saas/</link><pubDate>Fri, 13 Oct 2023 16:00:00 +0800</pubDate><guid>https://blog.kmtea.eu/p/231013-saas/</guid><description>&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/cover.jpg" alt="Featured image of post SaaS 平台 Python 应用部署实战" /&gt;&lt;h1 id="saas-平台-python-应用部署实战"&gt;SaaS 平台 Python 应用部署实战
&lt;/h1&gt;&lt;p&gt;如果你还不知道，
现在各大云服务巨头都提供了
&lt;strong&gt;永久免费&lt;/strong&gt; 的 Serverless 服务，
适合托管一些很小的应用。&lt;/p&gt;
&lt;p&gt;想把去年写的一个 Telegram 超轻量 bot
部署到 Azure Functions 上，
结果被微软念经一样的文档气得不轻，
遂决定写一篇 walkthrough 记录下。&lt;/p&gt;
&lt;p&gt;本教程所使用的代码放在
&lt;a class="link" href="https://github.com/KumaTea/KumaLiteBot" target="_blank" rel="noopener"
&gt;KumaTea/KumaLiteBot&lt;/a&gt;
这个 repo 里。&lt;/p&gt;
&lt;p&gt;目前示例 bot &lt;a class="link" href="https://t.me/KumaLiteBot" target="_blank" rel="noopener"
&gt;Kuma 发癫 Bot&lt;/a&gt;
托管在 Azure 上面。&lt;/p&gt;
&lt;h2 id="google-cloud-functions"&gt;Google Cloud Functions
&lt;/h2&gt;&lt;p&gt;谷歌的配置过程是最直观、方便、省心的，
其实这个bot之前就托管在谷歌云上，
但是因为有&lt;a class="link" href="#%e5%b0%8f%e6%8f%90%e7%a4%ba" &gt;隐性收费&lt;/a&gt;就关掉了。
只能说贵有贵的道理。&lt;/p&gt;
&lt;h3 id="创建-functions"&gt;创建 Functions
&lt;/h3&gt;&lt;p&gt;先进入 Functions 界面&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-01.jpg"
width="2559"
height="1440"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-01_hu_b8fce9e3a6624c92.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-01_hu_52bcad9fbcddb601.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="177"
data-flex-basis="426px"
&gt;&lt;/p&gt;
&lt;p&gt;点蓝色的创建&lt;/p&gt;
&lt;p&gt;基础信息，喜欢的名字就好&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-02.jpg"
width="1298"
height="1226"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-02_hu_cb73c2e71f450f45.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-02_hu_ce694c6ae8330e66.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="105"
data-flex-basis="254px"
&gt;&lt;/p&gt;
&lt;p&gt;Region 这里，一般根据最多人访问的地区来选&lt;/p&gt;
&lt;p&gt;因为我是 Telegram Bot,
选择 API 所在地荷兰阿姆斯特丹&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-03.jpg"
width="1042"
height="750"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-03_hu_c7272fea9ada3c9e.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-03_hu_e4035b65c895f670.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="138"
data-flex-basis="333px"
&gt;&lt;/p&gt;
&lt;p&gt;Trigger 这里 Auth 选择允许未认证调用&lt;/p&gt;
&lt;p&gt;你也不想每次打开都要输密码吧&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-04.jpg"
width="1187"
height="1110"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-04_hu_ef4c6dd8b583f5a0.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-04_hu_dfd89bd07bbbbda5.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="106"
data-flex-basis="256px"
&gt;&lt;/p&gt;
&lt;p&gt;下面配置按需求选，
我的 bot 用不到默认的 256 MB 就选了最小的&lt;/p&gt;
&lt;p&gt;环境变量记得
&lt;a class="link" href="#%e5%85%b6%e4%bb%96%e8%ae%be%e7%bd%ae" &gt;在 &lt;strong&gt;SECURITY AND IMAGE REPO&lt;/strong&gt; 设置&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-05.jpg"
width="999"
height="810"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-05_hu_2b3f503b399cf107.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-01-create-05_hu_bba0270a5cd5cf0d.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="123"
data-flex-basis="296px"
&gt;&lt;/p&gt;
&lt;p&gt;如果弹出启用 API 允许即可&lt;/p&gt;
&lt;h3 id="录入代码"&gt;录入代码
&lt;/h3&gt;&lt;p&gt;选择语言和版本&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-01.jpg"
width="1116"
height="803"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-01_hu_75a6c326c9195db7.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-01_hu_fd78f21e026e3e3c.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="138"
data-flex-basis="333px"
&gt;&lt;/p&gt;
&lt;p&gt;右边编辑器可以粘贴自己的代码了。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-02.jpg"
width="1593"
height="1105"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-02_hu_7768287e067e2669.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-02_hu_246bf1ebbe18d2e0.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="144"
data-flex-basis="345px"
&gt;&lt;/p&gt;
&lt;p&gt;注意，
&lt;strong&gt;Entry point&lt;/strong&gt; 这里要写的是你程序的入口，
一般是 &lt;code&gt;main&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;主函数示例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@functions_framework.http&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;POST&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;I am working!&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;update&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;de_json&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_json&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;force&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;bot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;inline_query&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;inline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reply_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nonsense_reply&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Unknown type. Ignoring...&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_json&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;force&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;code&gt;request&lt;/code&gt; 就是一个标准的 &lt;code&gt;flask.request&lt;/code&gt; 对象，
非常友好，与楼下高下立判&lt;/p&gt;
&lt;p&gt;然后点击左侧 &lt;code&gt;requirements.txt&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-03.jpg"
width="1194"
height="598"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-03_hu_dacc66ae9a6f86ef.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-02-code-03_hu_c61196c5e46bf4cc.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="199"
data-flex-basis="479px"
&gt;&lt;/p&gt;
&lt;p&gt;把依赖贴进去，就可以点下面的 &lt;strong&gt;Deploy&lt;/strong&gt; 了&lt;/p&gt;
&lt;h3 id="其他设置"&gt;其他设置
&lt;/h3&gt;&lt;p&gt;可以看到这里我失败了，因为忘了设置环境变量&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-01.jpg"
width="1779"
height="934"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-01_hu_890405c28e750a7d.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-01_hu_a474bb318d6f8476.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="190"
data-flex-basis="457px"
&gt;&lt;/p&gt;
&lt;p&gt;我需要的变量是认证的 &lt;code&gt;BOT_TOKEN&lt;/code&gt;,
&lt;strong&gt;安全地&lt;/strong&gt; 设置这个变量会很麻烦，介绍如下&lt;/p&gt;
&lt;p&gt;点击上方 Edit&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-02.jpg"
width="1075"
height="796"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-02_hu_2000273e2012b699.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-02_hu_73dc10b97f958d30.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="135"
data-flex-basis="324px"
&gt;&lt;/p&gt;
&lt;p&gt;进入 SECURITY AND IMAGE REPO&lt;/p&gt;
&lt;p&gt;点击 ADD A SECRET REFERENCE&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-03.jpg"
width="1385"
height="708"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-03_hu_7f6a2525d7ff6d01.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-03_hu_e72b74a95c010a6a.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="195"
data-flex-basis="469px"
&gt;&lt;/p&gt;
&lt;p&gt;这个时候会发现创建是灰的&lt;/p&gt;
&lt;p&gt;就需要先启用这个什么 Secret API&lt;/p&gt;
&lt;p&gt;点击左边 ENTER SECRET MANUALLY 就会弹出带你去的窗口&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-04.jpg"
width="1069"
height="588"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-04_hu_eb3d564b9fb24921.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-04_hu_b411cc82e9460dd9.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="181"
data-flex-basis="436px"
&gt;&lt;/p&gt;
&lt;p&gt;启用后回来刷新重新进入修改，就能看到可以创建了，右边会弹出窗口&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-05.jpg"
width="1106"
height="1325"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-05_hu_e7216fc21ce30946.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-05_hu_b406a99fc08200f.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="83"
data-flex-basis="200px"
&gt;&lt;/p&gt;
&lt;p&gt;Name 随便写，下面的 value 填你的 token&lt;/p&gt;
&lt;p&gt;然后 CREATE SECRET&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-06.jpg"
width="1044"
height="1096"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-06_hu_d6e1366ac9c81851.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-06_hu_3e6d27d529d99d51.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="95"
data-flex-basis="228px"
&gt;&lt;/p&gt;
&lt;p&gt;Reference method 选中暴露为环境变量&lt;/p&gt;
&lt;p&gt;下面环境变量输入你需要的，比如 &lt;code&gt;BOT_TOKEN&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;至于上面提示没有权限，实测没有影响&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;这是安全的方法，那么有没有不安全的呢？&lt;/p&gt;
&lt;p&gt;当然有&lt;/p&gt;
&lt;p&gt;&lt;del&gt;首先 Cloud Functions v1 就没有这么多幺蛾子&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-07.jpg"
width="1181"
height="958"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-07_hu_68b8b2bc82026c89.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-03-settings-07_hu_5800b599cc043d52.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="123"
data-flex-basis="295px"
&gt;&lt;/p&gt;
&lt;p&gt;只要在创建或者修改里面
&lt;strong&gt;RUNTIME&lt;/strong&gt; 下面 environment variables 里面填就好了&lt;/p&gt;
&lt;p&gt;当然你也可以直接写进代码里&lt;/p&gt;
&lt;h3 id="完成"&gt;完成
&lt;/h3&gt;&lt;p&gt;OK, 这就完了&lt;/p&gt;
&lt;p&gt;GCP 会自动开始 build 并部署&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-01.jpg"
width="1664"
height="1016"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-01_hu_781a97e37ecc8b43.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-01_hu_35337c1596791109.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="163"
data-flex-basis="393px"
&gt;&lt;/p&gt;
&lt;p&gt;可以看见已经成功运行&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-02.jpg"
width="1409"
height="657"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-02_hu_f214b24ab06291fa.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-02_hu_1cc7fd99716faeab.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="214"
data-flex-basis="514px"
&gt;&lt;/p&gt;
&lt;h4 id="小提示"&gt;小提示
&lt;/h4&gt;&lt;p&gt;Cloud Functions 有免费额度，
&lt;strong&gt;但 Storage 没有&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-03.jpg"
width="1657"
height="713"
srcset="https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-03_hu_e85196fa798e4747.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/GCP-04-done-03_hu_9d2b3a4c134ed32b.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="232"
data-flex-basis="557px"
&gt;&lt;/p&gt;
&lt;p&gt;部署完成后可以直接删掉自动生成的 buckets 避免扣钱，
完全不影响 bot 运行&lt;/p&gt;
&lt;h2 id="aws-lambda"&gt;AWS Lambda
&lt;/h2&gt;&lt;p&gt;AWS Lambda 比 GCP Cloud Functions
多一步手动上传依赖的步骤&lt;/p&gt;
&lt;h3 id="创建-lambda"&gt;创建 Lambda
&lt;/h3&gt;&lt;p&gt;在开始之前，记得先在右上角选择你想要的地区&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-01.jpg"
width="908"
height="570"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-01_hu_1dc97da6c16252fd.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-01_hu_b560bbfb3d849b58.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="159"
data-flex-basis="382px"
&gt;&lt;/p&gt;
&lt;p&gt;AWS 和别人不一样，它是先选地区，在这里创建的所有资源都会在这个区域&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-02.jpg"
width="2534"
height="1325"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-02_hu_3b2181c5e0753319.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-02_hu_43a291aa2f60f341.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="191"
data-flex-basis="458px"
&gt;&lt;/p&gt;
&lt;p&gt;右上角黄色按钮创建&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-03.jpg"
width="1705"
height="1160"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-03_hu_5ceaa3fdf8de7afa.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-03_hu_ba54a3ea57f15b78.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="146"
data-flex-basis="352px"
&gt;&lt;/p&gt;
&lt;p&gt;名字，语言和版本，架构&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-04.jpg"
width="1860"
height="1052"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-04_hu_821fb5252ab5811d.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-04_hu_8eba8ab1ed05e6e.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="176"
data-flex-basis="424px"
&gt;&lt;/p&gt;
&lt;p&gt;下方高级设置，要勾上 Enable Function URL,
这样才能从 URL 访问；&lt;/p&gt;
&lt;p&gt;Auth type 选 None&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-05.jpg"
width="2386"
height="1181"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-05_hu_f194cd8dc3cb499b.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-01-create-05_hu_70ba83a2fd598a65.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="202"
data-flex-basis="484px"
&gt;&lt;/p&gt;
&lt;h3 id="填入代码"&gt;填入代码
&lt;/h3&gt;&lt;p&gt;向下拉，把代码粘贴进编辑器，保存即可&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-02-code-01.jpg"
width="1614"
height="1169"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-02-code-01_hu_f18ab33f5277721e.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-02-code-01_hu_4877905cc5f87c5d.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="138"
data-flex-basis="331px"
&gt;&lt;/p&gt;
&lt;p&gt;主函数示例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;lambda_handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;statusCode&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;body&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;requestContext&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;http&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;POST&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;body&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;I am working!&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;update&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;de_json&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loads&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;body&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt; &lt;span class="n"&gt;bot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;inline_query&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;body&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;inline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;body&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reply_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nonsense_reply&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Unknown type. Ignoring...&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;code&gt;event&lt;/code&gt; 示例&lt;/p&gt;
&lt;span style="font-size: 0.5em"&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;GET: &lt;code&gt;{'version': '2.0', 'routeKey': '$default', 'rawPath': '/', 'rawQueryString': 'key=value', 'headers': {'sec-fetch-mode': 'navigate', 'x-amzn-tls-version': 'TLSv1.2', 'sec-fetch-site': 'none', 'accept-language': 'en-US,en;q=0.9', 'x-forwarded-proto': 'https', 'x-forwarded-port': '443', 'x-forwarded-for': '103.172.80.149', 'sec-fetch-user': '?1', 'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'x-amzn-tls-cipher-suite': 'ECDHE-RSA-AES128-GCM-SHA256', 'sec-ch-ua': '&amp;quot;Google Chrome&amp;quot;;v=&amp;quot;117&amp;quot;, &amp;quot;Not;A=Brand&amp;quot;;v=&amp;quot;8&amp;quot;, &amp;quot;Chromium&amp;quot;;v=&amp;quot;117&amp;quot;', 'sec-ch-ua-mobile': '?0', 'x-amzn-trace-id': 'Root=1-65284b56-7a462eea204cb5a45d3c0668', 'sec-ch-ua-platform': '&amp;quot;Windows&amp;quot;', 'host': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'upgrade-insecure-requests': '1', 'accept-encoding': 'gzip, deflate, br', 'sec-fetch-dest': 'document', 'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36'}, 'queryStringParameters': {'key': 'value'}, 'requestContext': {'accountId': 'anonymous', 'apiId': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'domainName': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'domainPrefix': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'http': {'method': 'GET', 'path': '/', 'protocol': 'HTTP/1.1', 'sourceIp': '103.172.80.149', 'userAgent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36'}, 'requestId': '90551f3b-4891-4b37-9aeb-71e2fae50ad1', 'routeKey': '$default', 'stage': '$default', 'time': '12/Oct/2023:19:39:02 +0000', 'timeEpoch': 1697139542555}, 'isBase64Encoded': False}&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;POST: &lt;code&gt;{'version': '2.0', 'routeKey': '$default', 'rawPath': '/', 'rawQueryString': '', 'headers': {'content-length': '372', 'x-amzn-tls-cipher-suite': 'ECDHE-RSA-AES128-GCM-SHA256', 'x-amzn-tls-version': 'TLSv1.2', 'x-amzn-trace-id': 'Root=1-65284b9f-3fff13e27bc794f95e3dbc98', 'x-forwarded-proto': 'https', 'host': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'x-forwarded-port': '443', 'content-type': 'application/json', 'x-forwarded-for': '91.108.6.19', 'accept-encoding': 'gzip, deflate'}, 'requestContext': {'accountId': 'anonymous', 'apiId': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'domainName': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'domainPrefix': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'http': {'method': 'POST', 'path': '/', 'protocol': 'HTTP/1.1', 'sourceIp': '91.108.6.19', 'userAgent': None}, 'requestId': '9fc841ed-6d28-461e-a657-565813752326', 'routeKey': '$default', 'stage': '$default', 'time': '12/Oct/2023:19:40:15 +0000', 'timeEpoch': 1697139615123}, 'body': '{&amp;quot;update_id&amp;quot;:11992905,\n&amp;quot;message&amp;quot;:{&amp;quot;message_id&amp;quot;:20,&amp;quot;from&amp;quot;:{&amp;quot;id&amp;quot;:5273618487,&amp;quot;is_bot&amp;quot;:false,&amp;quot;first_name&amp;quot;:&amp;quot;Kuma&amp;quot;,&amp;quot;last_name&amp;quot;:&amp;quot;Tea&amp;quot;,&amp;quot;username&amp;quot;:&amp;quot;realKumaTea&amp;quot;,&amp;quot;language_code&amp;quot;:&amp;quot;en&amp;quot;},&amp;quot;chat&amp;quot;:{&amp;quot;id&amp;quot;:5273618487,&amp;quot;first_name&amp;quot;:&amp;quot;Kuma&amp;quot;,&amp;quot;last_name&amp;quot;:&amp;quot;Tea&amp;quot;,&amp;quot;username&amp;quot;:&amp;quot;realKumaTea&amp;quot;,&amp;quot;type&amp;quot;:&amp;quot;private&amp;quot;},&amp;quot;date&amp;quot;:1697139614,&amp;quot;text&amp;quot;:&amp;quot;/start&amp;quot;,&amp;quot;entities&amp;quot;:[{&amp;quot;offset&amp;quot;:0,&amp;quot;length&amp;quot;:6,&amp;quot;type&amp;quot;:&amp;quot;bot_command&amp;quot;}]}}', 'isBase64Encoded': False}&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;/span&gt;
&lt;p&gt;Lambda 回传的 &lt;code&gt;response['body']&lt;/code&gt; 必须是 str 类型，
否则会报 &lt;code&gt;[ERROR] Runtime.MarshalError: Unable to marshal response&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="上传依赖"&gt;上传依赖
&lt;/h3&gt;&lt;p&gt;这个时候如果直接部署会报错：找不到依赖&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-01.jpg"
width="2064"
height="1108"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-01_hu_b75cd39388b671bb.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-01_hu_176a883394837ce4.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="186"
data-flex-basis="447px"
&gt;&lt;/p&gt;
&lt;p&gt;AWS Lambda 奇葩的设计导致我们不能上传
&lt;code&gt;requirements.txt&lt;/code&gt; 让它自己安装，
必须自己手动下载依赖并上传。&lt;/p&gt;
&lt;p&gt;首先需要找一台 Linux 机器，运行 docker&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;docker run -it --rm --name &lt;span class="nb"&gt;test&lt;/span&gt; python:3.11-slim /bin/bash
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-02.jpg"
width="1734"
height="957"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-02_hu_ba0362911e43293e.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-02_hu_b8d4928df9eaa805.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="181"
data-flex-basis="434px"
&gt;&lt;/p&gt;
&lt;p&gt;然后安装所需依赖&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;apt update -qq &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; apt install zip -y -qq
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir python
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;pip install &lt;span class="s2"&gt;&amp;#34;python-telegram-bot&amp;lt;20&amp;#34;&lt;/span&gt; -t python -q
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;zip -r python.zip python
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-03.jpg"
width="1734"
height="957"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-03_hu_64c7378b46cc110b.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-03_hu_f991c4a0beca20d.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="181"
data-flex-basis="434px"
&gt;&lt;/p&gt;
&lt;p&gt;再把生成的 &lt;code&gt;python.zip&lt;/code&gt; 复制出来&lt;/p&gt;
&lt;p&gt;记得新开个 shell 别傻乎乎把 docker 退了&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;docker cp test:/tmp/python.zip .
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Docker 容器这个时候可以关了&lt;/p&gt;
&lt;p&gt;继续下拉，在 Layers 这里点击 &lt;strong&gt;Add a layer&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-04.jpg"
width="2376"
height="936"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-04_hu_600364c48928a8be.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-04_hu_9f569cbe240cd5c2.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="253"
data-flex-basis="609px"
&gt;&lt;/p&gt;
&lt;p&gt;点 &lt;code&gt;AWS layers&lt;/code&gt; 上面那行小字 &lt;code&gt;create a new layer&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-05.jpg"
width="1629"
height="1155"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-05_hu_6b520c3436946459.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-05_hu_57a9a3c184e1266.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="141"
data-flex-basis="338px"
&gt;&lt;/p&gt;
&lt;p&gt;随便写，上传，提交&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-06.jpg"
width="1508"
height="1175"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-06_hu_6034e78f5f686cfc.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-06_hu_cad2f0b498a82422.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="128"
data-flex-basis="308px"
&gt;&lt;/p&gt;
&lt;p&gt;重新回到 Lambda dashboard，拉到下面，
点开熟悉的 Add a layer，
选择 Custom layers，选刚刚创建的，右下角 Add&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-07.jpg"
width="1587"
height="1162"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-07_hu_20134c27beb9de31.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-03-deps-07_hu_6d8f409b764d9fd7.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="136"
data-flex-basis="327px"
&gt;&lt;/p&gt;
&lt;p&gt;最后点 Code Source 旁边的 Deploy&lt;/p&gt;
&lt;h3 id="其他设置-1"&gt;其他设置
&lt;/h3&gt;&lt;p&gt;环境变量在下方 Configuration - Environment variables 里面，
设置简单不再赘述。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-04-settings-01.jpg"
width="1762"
height="1139"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-04-settings-01_hu_3b7cffe4b18cba5.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-04-settings-01_hu_a622f21d4c54677.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="154"
data-flex-basis="371px"
&gt;&lt;/p&gt;
&lt;h3 id="完成-1"&gt;完成
&lt;/h3&gt;&lt;p&gt;已成功运行&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/AWS-05-done-01.jpg"
width="2389"
height="1189"
srcset="https://blog.kmtea.eu/p/231013-saas/img/AWS-05-done-01_hu_afc6b07ae680f462.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/AWS-05-done-01_hu_ad74bead00835fe6.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="200"
data-flex-basis="482px"
&gt;&lt;/p&gt;
&lt;h2 id="azure-functions"&gt;Azure Functions
&lt;/h2&gt;&lt;p&gt;Azure 更是重量级，Web 端功能复杂甚至缺失，
必须使用 VS Code 才能完整部署&lt;/p&gt;
&lt;h3 id="准备"&gt;准备
&lt;/h3&gt;&lt;p&gt;你需要安装一个 &lt;a class="link" href="https://code.visualstudio.com/" target="_blank" rel="noopener"
&gt;VS Code&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;然后安装 &lt;a class="link" href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions" target="_blank" rel="noopener"
&gt;Azure Functions 插件&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-00-prep-01.jpg"
width="1822"
height="1014"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-00-prep-01_hu_8933c708d195df50.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-00-prep-01_hu_bf51815b27dfe012.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="179"
data-flex-basis="431px"
&gt;&lt;/p&gt;
&lt;p&gt;安装好之后，会在左边栏看到一个 A 图标&lt;/p&gt;
&lt;p&gt;点击并登录，直到看到你使用的产品都列出了&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-00-prep-02.jpg"
width="540"
height="577"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-00-prep-02_hu_964a040448f39dbb.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-00-prep-02_hu_eb10a0e69e609368.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="93"
data-flex-basis="224px"
&gt;&lt;/p&gt;
&lt;h3 id="创建-functions-1"&gt;创建 Functions
&lt;/h3&gt;&lt;p&gt;左下角 Workspace，鼠标移上去会有一个 Functions 图标出现&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-01.jpg"
width="573"
height="343"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-01_hu_a54fa71f4513d20d.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-01_hu_f4dbd3f59f081bd.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="167"
data-flex-basis="400px"
&gt;&lt;/p&gt;
&lt;p&gt;点击第二个 Create New Project&lt;/p&gt;
&lt;p&gt;回到上方，选择一个空文件夹&lt;/p&gt;
&lt;p&gt;语言根据需要选，模型默认 V2, Python 环境可以选择有的也可以跳过&lt;/p&gt;
&lt;p&gt;Template 选择 HTTP Trigger&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-02.jpg"
width="915"
height="423"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-02_hu_5d4e52c66771e909.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-02_hu_aa79f952cf55ae4c.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="216"
data-flex-basis="519px"
&gt;&lt;/p&gt;
&lt;p&gt;Trigger 名称是你的 API 路径，这里我改成了 &lt;code&gt;bot&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-03.jpg"
width="926"
height="212"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-03_hu_f4395d5a89e3f37f.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-03_hu_ff1e10672caf2457.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="436"
data-flex-basis="1048px"
&gt;&lt;/p&gt;
&lt;p&gt;然后认证选择 Anonymous&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-04.jpg"
width="917"
height="220"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-04_hu_6831243bac2b8890.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-01-create-04_hu_7ebcb9114e78b2ab.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="416"
data-flex-basis="1000px"
&gt;&lt;/p&gt;
&lt;p&gt;就可以打开生成的代码文件编辑了&lt;/p&gt;
&lt;h3 id="填入代码-1"&gt;填入代码
&lt;/h3&gt;&lt;p&gt;首先这个 Create New Function 是没有用的&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-02-code-01.jpg"
width="515"
height="317"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-02-code-01_hu_a6b69538bc5103be.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-02-code-01_hu_812740477091f167.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="162"
data-flex-basis="389px"
&gt;&lt;/p&gt;
&lt;p&gt;它不过是在你的代码里加一个入口，可以自己写&lt;/p&gt;
&lt;p&gt;把代码贴进去就好了，不赘叙&lt;/p&gt;
&lt;p&gt;主函数示例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@app.route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;bot&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;auth_level&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AuthLevel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ANONYMOUS&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;POST&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;I am working!&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;update&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;de_json&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_json&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;bot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;inline_query&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;inline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reply_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nonsense_reply&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Unknown type. Ignoring...&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_json&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;这里要特别注意的是，
入口参数 &lt;strong&gt;必须是 &lt;code&gt;req&lt;/code&gt;&lt;/strong&gt;，
如果不一致，部署后会找不到 HTTP Trigger!!!&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-02-code-02.jpg"
width="812"
height="418"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-02-code-02_hu_390617939bc2d6c6.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-02-code-02_hu_2f2eaaae6297fba2.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="194"
data-flex-basis="466px"
&gt;&lt;/p&gt;
&lt;p&gt;微软没有任何文档提到这一点！我是怎么发现的呢？&lt;/p&gt;
&lt;p&gt;原先一直用的是 &lt;code&gt;request&lt;/code&gt; 当入口，
因为一直部署失败，乱翻文档，在 &lt;a class="link" href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger#decorators" target="_blank" rel="noopener"
&gt;HTTP Trigger&lt;/a&gt; 看到这么一句&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;trigger_arg_name&lt;/code&gt; Argument name for HttpRequest, defaults to &amp;lsquo;req&amp;rsquo;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;没事限制参数干嘛？我就改成 &lt;code&gt;req&lt;/code&gt; 居然就成功了&lt;/p&gt;
&lt;h3 id="部署和设置"&gt;部署和设置
&lt;/h3&gt;&lt;p&gt;工作区 Azure 图标 - Create Function App in Azure&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-01.jpg"
width="802"
height="382"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-01_hu_b6d123fef34e5872.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-01_hu_3ebc5bbf90b54c45.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="209"
data-flex-basis="503px"
&gt;&lt;/p&gt;
&lt;p&gt;会需要你填写一个唯一的不重复的名字，因为这个到时候会写到 API 的 URL 里面&lt;/p&gt;
&lt;p&gt;我这里用的是 &lt;code&gt;kmlt&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;然后选择环境和地区，完成和等待创建即可&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-02.jpg"
width="907"
height="590"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-02_hu_84e52832fdb60b9.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-02_hu_bea91cc18622f2aa.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="153"
data-flex-basis="368px"
&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-03.jpg"
width="908"
height="587"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-03_hu_ed82a0056e404c82.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-03_hu_70fd0af96fc321e0.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="154"
data-flex-basis="371px"
&gt;&lt;/p&gt;
&lt;p&gt;随后上方可见刚刚创建的 Function App&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-04.jpg"
width="457"
height="294"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-04_hu_9b1eb4903916c5ad.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-04_hu_88d888ac04dba9c4.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="155"
data-flex-basis="373px"
&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;创建好，部署之前，
如果你有环境变量需要设置，
点开
Azure -
Resources -
Function App -
kmlt,
在 &lt;strong&gt;&lt;code&gt;Application Settings&lt;/code&gt;&lt;/strong&gt; 上右键，
在弹出窗口中分别填入环境变量的名字和值&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-05.jpg"
width="498"
height="254"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-05_hu_f887bc19776b8519.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-05_hu_fbe325fec20292ac.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="196"
data-flex-basis="470px"
&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;完成后，点击 Functions 图标，选择
&lt;strong&gt;Deploy to Function App&amp;hellip;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;上方选择刚创建的，
弹出警告点 Deploy&lt;/p&gt;
&lt;p&gt;右下角会开始输出部署 log&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-06.jpg"
width="1088"
height="482"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-06_hu_c4c6cbfe4c9386d2.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-03-deploy-06_hu_f1406ee9b9781b97.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="225"
data-flex-basis="541px"
&gt;&lt;/p&gt;
&lt;h3 id="完成-2"&gt;完成
&lt;/h3&gt;&lt;p&gt;完成后 log 会显示你的 Trigger URL&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-04-done-01.jpg"
width="1201"
height="514"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-04-done-01_hu_eac26370bca40a9b.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-04-done-01_hu_d5e836a4dbfbf56a.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="233"
data-flex-basis="560px"
&gt;&lt;/p&gt;
&lt;p&gt;可以打开 URL 测试&lt;/p&gt;
&lt;p&gt;&lt;img src="https://blog.kmtea.eu/p/231013-saas/img/Azure-04-done-02.jpg"
width="2560"
height="1262"
srcset="https://blog.kmtea.eu/p/231013-saas/img/Azure-04-done-02_hu_6dd8492fb7564fa2.jpg 480w, https://blog.kmtea.eu/p/231013-saas/img/Azure-04-done-02_hu_cb55a61265e1ee1c.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="202"
data-flex-basis="486px"
&gt;&lt;/p&gt;
&lt;h2 id="总结"&gt;总结
&lt;/h2&gt;&lt;p&gt;平心而论，
Azure 的部署过程其实是很方便的，
尤其是对于那些用惯了 VS Code 的人来说。&lt;/p&gt;
&lt;p&gt;然而由于微软的文档过于语焉不详才让我吃了那么多苦头，
甚至没有这件事就没有这篇发奋而作的 blog，
笑死。&lt;/p&gt;</description></item></channel></rss>