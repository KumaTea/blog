<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="GCP Cloud Functions, AWS Lambda and Azure Functions"><title>SaaS 平台 Python 应用部署实战</title>
<link rel=canonical href=https://blog.kmtea.eu/p/231013-saas/><link rel=stylesheet href=/scss/style.min.5da39f2fc2a90c387e54cd5c122e5766f35470e177f43e3eab38e4b55e36d941.css><meta property='og:title' content="SaaS 平台 Python 应用部署实战"><meta property='og:description' content="GCP Cloud Functions, AWS Lambda and Azure Functions"><meta property='og:url' content='https://blog.kmtea.eu/p/231013-saas/'><meta property='og:site_name' content="酷玛阁 | KumaTea's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='Guide'><meta property='article:tag' content='SaaS'><meta property='article:tag' content='Google'><meta property='article:tag' content='Amazon'><meta property='article:tag' content='Azure'><meta property='article:published_time' content='2023-10-13T16:00:00+08:00'><meta property='article:modified_time' content='2023-10-14T02:30:58+08:00'><meta property='og:image' content='https://blog.kmtea.eu/p/231013-saas/img/cover.jpg'><meta name=twitter:site content="@KumaTea0"><meta name=twitter:creator content="@KumaTea0"><meta name=twitter:title content="SaaS 平台 Python 应用部署实战"><meta name=twitter:description content="GCP Cloud Functions, AWS Lambda and Azure Functions"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://blog.kmtea.eu/p/231013-saas/img/cover.jpg'><link rel="shortcut icon" href=//kmtea.eu/res/2206/avatar.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-P86D5805EG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-P86D5805EG")}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3876653977265938" crossorigin=anonymous></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=//kmtea.eu/res/2206/avatar.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>酷玛阁 | KumaTea's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>目录</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>联系</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#google-cloud-functions>Google Cloud Functions</a><ol><li><a href=#创建-functions>创建 Functions</a></li><li><a href=#录入代码>录入代码</a></li><li><a href=#其他设置>其他设置</a></li><li><a href=#完成>完成</a><ol><li><a href=#小提示>小提示</a></li></ol></li></ol></li><li><a href=#aws-lambda>AWS Lambda</a><ol><li><a href=#创建-lambda>创建 Lambda</a></li><li><a href=#填入代码>填入代码</a></li><li><a href=#上传依赖>上传依赖</a></li><li><a href=#其他设置-1>其他设置</a></li><li><a href=#完成-1>完成</a></li></ol></li><li><a href=#azure-functions>Azure Functions</a><ol><li><a href=#准备>准备</a></li><li><a href=#创建-functions-1>创建 Functions</a></li><li><a href=#填入代码-1>填入代码</a></li><li><a href=#部署和设置>部署和设置</a></li><li><a href=#完成-2>完成</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/231013-saas/><img src=/p/231013-saas/img/cover_hu153247619892912786.jpg srcset="/p/231013-saas/img/cover_hu153247619892912786.jpg 800w, /p/231013-saas/img/cover_hu6253601089011219947.jpg 1600w" width=800 height=450 loading=lazy alt="Featured image of post SaaS 平台 Python 应用部署实战"></a></div><div class=article-details><header class=article-category><a href=/categories/guides/>Guides</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/231013-saas/>SaaS 平台 Python 应用部署实战</a></h2><h3 class=article-subtitle>GCP Cloud Functions, AWS Lambda and Azure Functions</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-10-13</time></div><div><svg class="icon icon-tabler icon-tabler-pen" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M4 20h3L19 8a1.5 1.5.0 00-3-3L4 17v3"/><line x1="15.25" y1="6.75" x2="17.25" y2="8.75"/><circle cx="18" cy="18" r="4"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-lastmod>2023-10-14</time></div></footer></div></header><section class=article-content><h1 id=saas-平台-python-应用部署实战>SaaS 平台 Python 应用部署实战</h1><p>如果你还不知道，
现在各大云服务巨头都提供了
<strong>永久免费</strong> 的 Serverless 服务，
适合托管一些很小的应用。</p><p>想把去年写的一个 Telegram 超轻量 bot
部署到 Azure Functions 上，
结果被微软念经一样的文档气得不轻，
遂决定写一篇 walkthrough 记录下。</p><p>本教程所使用的代码放在
<a class=link href=https://github.com/KumaTea/KumaLiteBot target=_blank rel=noopener>KumaTea/KumaLiteBot</a>
这个 repo 里。</p><p>目前示例 bot <a class=link href=https://t.me/KumaLiteBot target=_blank rel=noopener>Kuma 发癫 Bot</a>
托管在 Azure 上面。</p><h2 id=google-cloud-functions>Google Cloud Functions</h2><p>谷歌的配置过程是最直观、方便、省心的，
其实这个bot之前就托管在谷歌云上，
但是因为有<a class=link href=#%e5%b0%8f%e6%8f%90%e7%a4%ba>隐性收费</a>就关掉了。
只能说贵有贵的道理。</p><h3 id=创建-functions>创建 Functions</h3><p>先进入 Functions 界面</p><p><img src=/p/231013-saas/img/GCP-01-create-01.jpg width=2559 height=1440 srcset="/p/231013-saas/img/GCP-01-create-01_hu14705452929452541993.jpg 480w, /p/231013-saas/img/GCP-01-create-01_hu9060792579635404824.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>点蓝色的创建</p><p>基础信息，喜欢的名字就好</p><p><img src=/p/231013-saas/img/GCP-01-create-02.jpg width=1298 height=1226 srcset="/p/231013-saas/img/GCP-01-create-02_hu8112394986541672432.jpg 480w, /p/231013-saas/img/GCP-01-create-02_hu14097186718680253304.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=105 data-flex-basis=254px></p><p>Region 这里，一般根据最多人访问的地区来选</p><p>因为我是 Telegram Bot,
选择 API 所在地荷兰阿姆斯特丹</p><p><img src=/p/231013-saas/img/GCP-01-create-03.jpg width=1042 height=750 srcset="/p/231013-saas/img/GCP-01-create-03_hu7840371989559977898.jpg 480w, /p/231013-saas/img/GCP-01-create-03_hu2388937164691020094.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=138 data-flex-basis=333px></p><p>Trigger 这里 Auth 选择允许未认证调用</p><p>你也不想每次打开都要输密码吧</p><p><img src=/p/231013-saas/img/GCP-01-create-04.jpg width=1187 height=1110 srcset="/p/231013-saas/img/GCP-01-create-04_hu10177163865714681086.jpg 480w, /p/231013-saas/img/GCP-01-create-04_hu17935334666275898496.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=106 data-flex-basis=256px></p><p>下面配置按需求选，
我的 bot 用不到默认的 256 MB 就选了最小的</p><p>环境变量记得
<a class=link href=#%e5%85%b6%e4%bb%96%e8%ae%be%e7%bd%ae>在 <strong>SECURITY AND IMAGE REPO</strong> 设置</a></p><p><img src=/p/231013-saas/img/GCP-01-create-05.jpg width=999 height=810 srcset="/p/231013-saas/img/GCP-01-create-05_hu8485072321679570179.jpg 480w, /p/231013-saas/img/GCP-01-create-05_hu4129337847343362776.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=123 data-flex-basis=296px></p><p>如果弹出启用 API 允许即可</p><h3 id=录入代码>录入代码</h3><p>选择语言和版本</p><p><img src=/p/231013-saas/img/GCP-02-code-01.jpg width=1116 height=803 srcset="/p/231013-saas/img/GCP-02-code-01_hu3536844224101244468.jpg 480w, /p/231013-saas/img/GCP-02-code-01_hu9207139539209726809.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=138 data-flex-basis=333px></p><p>右边编辑器可以粘贴自己的代码了。</p><p><img src=/p/231013-saas/img/GCP-02-code-02.jpg width=1593 height=1105 srcset="/p/231013-saas/img/GCP-02-code-02_hu1418486180694715279.jpg 480w, /p/231013-saas/img/GCP-02-code-02_hu870626902784953755.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=144 data-flex-basis=345px></p><p>注意，
<strong>Entry point</strong> 这里要写的是你程序的入口，
一般是 <code>main</code></p><p>主函数示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@functions_framework.http</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s2>&#34;POST&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;I am working!&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span> <span class=o>=</span> <span class=n>Update</span><span class=o>.</span><span class=n>de_json</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>(</span><span class=n>force</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span> <span class=n>bot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>update</span><span class=o>.</span><span class=n>inline_query</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>inline</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span> <span class=o>=</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>msg</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>id</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=n>nonsense_reply</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Unknown type. Ignoring...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>(</span><span class=n>force</span><span class=o>=</span><span class=kc>True</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span> <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>res</span><span class=p>)</span> <span class=ow>is</span> <span class=nb>str</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>request</code> 就是一个标准的 <code>flask.request</code> 对象，
非常友好，与楼下高下立判</p><p>然后点击左侧 <code>requirements.txt</code></p><p><img src=/p/231013-saas/img/GCP-02-code-03.jpg width=1194 height=598 srcset="/p/231013-saas/img/GCP-02-code-03_hu3224540501554425337.jpg 480w, /p/231013-saas/img/GCP-02-code-03_hu156739379416319819.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=199 data-flex-basis=479px></p><p>把依赖贴进去，就可以点下面的 <strong>Deploy</strong> 了</p><h3 id=其他设置>其他设置</h3><p>可以看到这里我失败了，因为忘了设置环境变量</p><p><img src=/p/231013-saas/img/GCP-03-settings-01.jpg width=1779 height=934 srcset="/p/231013-saas/img/GCP-03-settings-01_hu17086344822140571666.jpg 480w, /p/231013-saas/img/GCP-03-settings-01_hu10277539634291805814.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=190 data-flex-basis=457px></p><p>我需要的变量是认证的 <code>BOT_TOKEN</code>,
<strong>安全地</strong> 设置这个变量会很麻烦，介绍如下</p><p>点击上方 Edit</p><p><img src=/p/231013-saas/img/GCP-03-settings-02.jpg width=1075 height=796 srcset="/p/231013-saas/img/GCP-03-settings-02_hu11394024983716581967.jpg 480w, /p/231013-saas/img/GCP-03-settings-02_hu12560862030564317560.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=135 data-flex-basis=324px></p><p>进入 SECURITY AND IMAGE REPO</p><p>点击 ADD A SECRET REFERENCE</p><p><img src=/p/231013-saas/img/GCP-03-settings-03.jpg width=1385 height=708 srcset="/p/231013-saas/img/GCP-03-settings-03_hu8380833605027524221.jpg 480w, /p/231013-saas/img/GCP-03-settings-03_hu12134640748470481059.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=195 data-flex-basis=469px></p><p>这个时候会发现创建是灰的</p><p>就需要先启用这个什么 Secret API</p><p>点击左边 ENTER SECRET MANUALLY 就会弹出带你去的窗口</p><p><img src=/p/231013-saas/img/GCP-03-settings-04.jpg width=1069 height=588 srcset="/p/231013-saas/img/GCP-03-settings-04_hu13406019329127575429.jpg 480w, /p/231013-saas/img/GCP-03-settings-04_hu14628185123544318126.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=181 data-flex-basis=436px></p><p>启用后回来刷新重新进入修改，就能看到可以创建了，右边会弹出窗口</p><p><img src=/p/231013-saas/img/GCP-03-settings-05.jpg width=1106 height=1325 srcset="/p/231013-saas/img/GCP-03-settings-05_hu4515725947781318504.jpg 480w, /p/231013-saas/img/GCP-03-settings-05_hu16761603232520999152.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=83 data-flex-basis=200px></p><p>Name 随便写，下面的 value 填你的 token</p><p>然后 CREATE SECRET</p><p><img src=/p/231013-saas/img/GCP-03-settings-06.jpg width=1044 height=1096 srcset="/p/231013-saas/img/GCP-03-settings-06_hu6977364617347527147.jpg 480w, /p/231013-saas/img/GCP-03-settings-06_hu3892889901469804197.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=95 data-flex-basis=228px></p><p>Reference method 选中暴露为环境变量</p><p>下面环境变量输入你需要的，比如 <code>BOT_TOKEN</code></p><p>至于上面提示没有权限，实测没有影响</p><hr><p>这是安全的方法，那么有没有不安全的呢？</p><p>当然有</p><p><del>首先 Cloud Functions v1 就没有这么多幺蛾子</del></p><p><img src=/p/231013-saas/img/GCP-03-settings-07.jpg width=1181 height=958 srcset="/p/231013-saas/img/GCP-03-settings-07_hu7762391622865014223.jpg 480w, /p/231013-saas/img/GCP-03-settings-07_hu2779864096963058390.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=123 data-flex-basis=295px></p><p>只要在创建或者修改里面
<strong>RUNTIME</strong> 下面 environment variables 里面填就好了</p><p>当然你也可以直接写进代码里</p><h3 id=完成>完成</h3><p>OK, 这就完了</p><p>GCP 会自动开始 build 并部署</p><p><img src=/p/231013-saas/img/GCP-04-done-01.jpg width=1664 height=1016 srcset="/p/231013-saas/img/GCP-04-done-01_hu1448367893956541747.jpg 480w, /p/231013-saas/img/GCP-04-done-01_hu11723945714196543767.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=163 data-flex-basis=393px></p><p>可以看见已经成功运行</p><p><img src=/p/231013-saas/img/GCP-04-done-02.jpg width=1409 height=657 srcset="/p/231013-saas/img/GCP-04-done-02_hu3025383617598080380.jpg 480w, /p/231013-saas/img/GCP-04-done-02_hu13024558237334503700.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=214 data-flex-basis=514px></p><h4 id=小提示>小提示</h4><p>Cloud Functions 有免费额度，
<strong>但 Storage 没有</strong>。</p><p><img src=/p/231013-saas/img/GCP-04-done-03.jpg width=1657 height=713 srcset="/p/231013-saas/img/GCP-04-done-03_hu16159881157763020925.jpg 480w, /p/231013-saas/img/GCP-04-done-03_hu4758796206900536267.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=232 data-flex-basis=557px></p><p>部署完成后可以直接删掉自动生成的 buckets 避免扣钱，
完全不影响 bot 运行</p><h2 id=aws-lambda>AWS Lambda</h2><p>AWS Lambda 比 GCP Cloud Functions
多一步手动上传依赖的步骤</p><h3 id=创建-lambda>创建 Lambda</h3><p>在开始之前，记得先在右上角选择你想要的地区</p><p><img src=/p/231013-saas/img/AWS-01-create-01.jpg width=908 height=570 srcset="/p/231013-saas/img/AWS-01-create-01_hu453087798613292091.jpg 480w, /p/231013-saas/img/AWS-01-create-01_hu16780465458903390463.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=159 data-flex-basis=382px></p><p>AWS 和别人不一样，它是先选地区，在这里创建的所有资源都会在这个区域</p><p><img src=/p/231013-saas/img/AWS-01-create-02.jpg width=2534 height=1325 srcset="/p/231013-saas/img/AWS-01-create-02_hu511695629448804966.jpg 480w, /p/231013-saas/img/AWS-01-create-02_hu3341579557287483763.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=191 data-flex-basis=458px></p><p>右上角黄色按钮创建</p><p><img src=/p/231013-saas/img/AWS-01-create-03.jpg width=1705 height=1160 srcset="/p/231013-saas/img/AWS-01-create-03_hu8616512774298884953.jpg 480w, /p/231013-saas/img/AWS-01-create-03_hu11295020841497111450.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=146 data-flex-basis=352px></p><p>名字，语言和版本，架构</p><p><img src=/p/231013-saas/img/AWS-01-create-04.jpg width=1860 height=1052 srcset="/p/231013-saas/img/AWS-01-create-04_hu11129115562583212311.jpg 480w, /p/231013-saas/img/AWS-01-create-04_hu16208841806529663609.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=176 data-flex-basis=424px></p><p>下方高级设置，要勾上 Enable Function URL,
这样才能从 URL 访问；</p><p>Auth type 选 None</p><p><img src=/p/231013-saas/img/AWS-01-create-05.jpg width=2386 height=1181 srcset="/p/231013-saas/img/AWS-01-create-05_hu11825177698917447179.jpg 480w, /p/231013-saas/img/AWS-01-create-05_hu2446050047443854193.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=202 data-flex-basis=484px></p><h3 id=填入代码>填入代码</h3><p>向下拉，把代码粘贴进编辑器，保存即可</p><p><img src=/p/231013-saas/img/AWS-02-code-01.jpg width=1614 height=1169 srcset="/p/231013-saas/img/AWS-02-code-01_hu12018951498884296395.jpg 480w, /p/231013-saas/img/AWS-02-code-01_hu1635104401502570770.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=138 data-flex-basis=331px></p><p>主函数示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>lambda_handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;statusCode&#39;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;body&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s1>&#39;requestContext&#39;</span><span class=p>][</span><span class=s1>&#39;http&#39;</span><span class=p>][</span><span class=s1>&#39;method&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>method</span> <span class=o>==</span> <span class=s2>&#34;POST&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span><span class=p>[</span><span class=s1>&#39;body&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;I am working!&#39;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span> <span class=o>=</span> <span class=n>Update</span><span class=o>.</span><span class=n>de_json</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;body&#39;</span><span class=p>]),</span> <span class=n>bot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>update</span><span class=o>.</span><span class=n>inline_query</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span><span class=p>[</span><span class=s1>&#39;body&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>inline</span><span class=p>(</span><span class=n>update</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span> <span class=o>=</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>msg</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>id</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span><span class=p>[</span><span class=s1>&#39;body&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=n>nonsense_reply</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Unknown type. Ignoring...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span>
</span></span></code></pre></td></tr></table></div></div><p><code>event</code> 示例</p><span style=font-size:.5em><blockquote><ul><li><p>GET: <code>{'version': '2.0', 'routeKey': '$default', 'rawPath': '/', 'rawQueryString': 'key=value', 'headers': {'sec-fetch-mode': 'navigate', 'x-amzn-tls-version': 'TLSv1.2', 'sec-fetch-site': 'none', 'accept-language': 'en-US,en;q=0.9', 'x-forwarded-proto': 'https', 'x-forwarded-port': '443', 'x-forwarded-for': '103.172.80.149', 'sec-fetch-user': '?1', 'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'x-amzn-tls-cipher-suite': 'ECDHE-RSA-AES128-GCM-SHA256', 'sec-ch-ua': '"Google Chrome";v="117", "Not;A=Brand";v="8", "Chromium";v="117"', 'sec-ch-ua-mobile': '?0', 'x-amzn-trace-id': 'Root=1-65284b56-7a462eea204cb5a45d3c0668', 'sec-ch-ua-platform': '"Windows"', 'host': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'upgrade-insecure-requests': '1', 'accept-encoding': 'gzip, deflate, br', 'sec-fetch-dest': 'document', 'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36'}, 'queryStringParameters': {'key': 'value'}, 'requestContext': {'accountId': 'anonymous', 'apiId': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'domainName': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'domainPrefix': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'http': {'method': 'GET', 'path': '/', 'protocol': 'HTTP/1.1', 'sourceIp': '103.172.80.149', 'userAgent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36'}, 'requestId': '90551f3b-4891-4b37-9aeb-71e2fae50ad1', 'routeKey': '$default', 'stage': '$default', 'time': '12/Oct/2023:19:39:02 +0000', 'timeEpoch': 1697139542555}, 'isBase64Encoded': False}</code></p></li><li><p>POST: <code>{'version': '2.0', 'routeKey': '$default', 'rawPath': '/', 'rawQueryString': '', 'headers': {'content-length': '372', 'x-amzn-tls-cipher-suite': 'ECDHE-RSA-AES128-GCM-SHA256', 'x-amzn-tls-version': 'TLSv1.2', 'x-amzn-trace-id': 'Root=1-65284b9f-3fff13e27bc794f95e3dbc98', 'x-forwarded-proto': 'https', 'host': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'x-forwarded-port': '443', 'content-type': 'application/json', 'x-forwarded-for': '91.108.6.19', 'accept-encoding': 'gzip, deflate'}, 'requestContext': {'accountId': 'anonymous', 'apiId': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'domainName': '7o22cfijy5jiujzbih6aov5yvy0hasni.lambda-url.eu-central-1.on.aws', 'domainPrefix': '7o22cfijy5jiujzbih6aov5yvy0hasni', 'http': {'method': 'POST', 'path': '/', 'protocol': 'HTTP/1.1', 'sourceIp': '91.108.6.19', 'userAgent': None}, 'requestId': '9fc841ed-6d28-461e-a657-565813752326', 'routeKey': '$default', 'stage': '$default', 'time': '12/Oct/2023:19:40:15 +0000', 'timeEpoch': 1697139615123}, 'body': '{"update_id":11992905,\n"message":{"message_id":20,"from":{"id":5273618487,"is_bot":false,"first_name":"Kuma","last_name":"Tea","username":"realKumaTea","language_code":"en"},"chat":{"id":5273618487,"first_name":"Kuma","last_name":"Tea","username":"realKumaTea","type":"private"},"date":1697139614,"text":"/start","entities":[{"offset":0,"length":6,"type":"bot_command"}]}}', 'isBase64Encoded': False}</code></p></li></ul></blockquote></span><p>Lambda 回传的 <code>response['body']</code> 必须是 str 类型，
否则会报 <code>[ERROR] Runtime.MarshalError: Unable to marshal response</code></p><h3 id=上传依赖>上传依赖</h3><p>这个时候如果直接部署会报错：找不到依赖</p><p><img src=/p/231013-saas/img/AWS-03-deps-01.jpg width=2064 height=1108 srcset="/p/231013-saas/img/AWS-03-deps-01_hu2153483226229292441.jpg 480w, /p/231013-saas/img/AWS-03-deps-01_hu4749157715518673359.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=186 data-flex-basis=447px></p><p>AWS Lambda 奇葩的设计导致我们不能上传
<code>requirements.txt</code> 让它自己安装，
必须自己手动下载依赖并上传。</p><p>首先需要找一台 Linux 机器，运行 docker</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker run -it --rm --name <span class=nb>test</span> python:3.11-slim /bin/bash
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/231013-saas/img/AWS-03-deps-02.jpg width=1734 height=957 srcset="/p/231013-saas/img/AWS-03-deps-02_hu3670373866154042481.jpg 480w, /p/231013-saas/img/AWS-03-deps-02_hu8418290220951087373.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=181 data-flex-basis=434px></p><p>然后安装所需依赖</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apt update -qq <span class=o>&amp;&amp;</span> apt install zip -y -qq
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /tmp
</span></span><span class=line><span class=cl>mkdir python
</span></span><span class=line><span class=cl>pip install <span class=s2>&#34;python-telegram-bot&lt;20&#34;</span> -t python -q
</span></span><span class=line><span class=cl>zip -r python.zip python
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/231013-saas/img/AWS-03-deps-03.jpg width=1734 height=957 srcset="/p/231013-saas/img/AWS-03-deps-03_hu11496344352281080443.jpg 480w, /p/231013-saas/img/AWS-03-deps-03_hu12447185659888620514.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=181 data-flex-basis=434px></p><p>再把生成的 <code>python.zip</code> 复制出来</p><p>记得新开个 shell 别傻乎乎把 docker 退了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker cp test:/tmp/python.zip .
</span></span></code></pre></td></tr></table></div></div><p>Docker 容器这个时候可以关了</p><p>继续下拉，在 Layers 这里点击 <strong>Add a layer</strong></p><p><img src=/p/231013-saas/img/AWS-03-deps-04.jpg width=2376 height=936 srcset="/p/231013-saas/img/AWS-03-deps-04_hu2703055514179664128.jpg 480w, /p/231013-saas/img/AWS-03-deps-04_hu8784720625154642390.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=253 data-flex-basis=609px></p><p>点 <code>AWS layers</code> 上面那行小字 <code>create a new layer</code></p><p><img src=/p/231013-saas/img/AWS-03-deps-05.jpg width=1629 height=1155 srcset="/p/231013-saas/img/AWS-03-deps-05_hu4238038673700561599.jpg 480w, /p/231013-saas/img/AWS-03-deps-05_hu7608046687060656042.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=141 data-flex-basis=338px></p><p>随便写，上传，提交</p><p><img src=/p/231013-saas/img/AWS-03-deps-06.jpg width=1508 height=1175 srcset="/p/231013-saas/img/AWS-03-deps-06_hu2244480779423569747.jpg 480w, /p/231013-saas/img/AWS-03-deps-06_hu4041609238946004086.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=128 data-flex-basis=308px></p><p>重新回到 Lambda dashboard，拉到下面，
点开熟悉的 Add a layer，
选择 Custom layers，选刚刚创建的，右下角 Add</p><p><img src=/p/231013-saas/img/AWS-03-deps-07.jpg width=1587 height=1162 srcset="/p/231013-saas/img/AWS-03-deps-07_hu11969551642987848598.jpg 480w, /p/231013-saas/img/AWS-03-deps-07_hu7488998201225835368.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=136 data-flex-basis=327px></p><p>最后点 Code Source 旁边的 Deploy</p><h3 id=其他设置-1>其他设置</h3><p>环境变量在下方 Configuration - Environment variables 里面，
设置简单不再赘述。</p><p><img src=/p/231013-saas/img/AWS-04-settings-01.jpg width=1762 height=1139 srcset="/p/231013-saas/img/AWS-04-settings-01_hu367572219322702365.jpg 480w, /p/231013-saas/img/AWS-04-settings-01_hu13441717985449135968.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=154 data-flex-basis=371px></p><h3 id=完成-1>完成</h3><p>已成功运行</p><p><img src=/p/231013-saas/img/AWS-05-done-01.jpg width=2389 height=1189 srcset="/p/231013-saas/img/AWS-05-done-01_hu18445537890551651231.jpg 480w, /p/231013-saas/img/AWS-05-done-01_hu1520526882408444364.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=200 data-flex-basis=482px></p><h2 id=azure-functions>Azure Functions</h2><p>Azure 更是重量级，Web 端功能复杂甚至缺失，
必须使用 VS Code 才能完整部署</p><h3 id=准备>准备</h3><p>你需要安装一个 <a class=link href=https://code.visualstudio.com/ target=_blank rel=noopener>VS Code</a></p><p>然后安装 <a class=link href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions" target=_blank rel=noopener>Azure Functions 插件</a></p><p><img src=/p/231013-saas/img/Azure-00-prep-01.jpg width=1822 height=1014 srcset="/p/231013-saas/img/Azure-00-prep-01_hu4446289039351752392.jpg 480w, /p/231013-saas/img/Azure-00-prep-01_hu9856497650546550429.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=179 data-flex-basis=431px></p><p>安装好之后，会在左边栏看到一个 A 图标</p><p>点击并登录，直到看到你使用的产品都列出了</p><p><img src=/p/231013-saas/img/Azure-00-prep-02.jpg width=540 height=577 srcset="/p/231013-saas/img/Azure-00-prep-02_hu2227057863440527393.jpg 480w, /p/231013-saas/img/Azure-00-prep-02_hu13259796978143375067.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=93 data-flex-basis=224px></p><h3 id=创建-functions-1>创建 Functions</h3><p>左下角 Workspace，鼠标移上去会有一个 Functions 图标出现</p><p><img src=/p/231013-saas/img/Azure-01-create-01.jpg width=573 height=343 srcset="/p/231013-saas/img/Azure-01-create-01_hu12288808707644259698.jpg 480w, /p/231013-saas/img/Azure-01-create-01_hu14947458655151831596.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=167 data-flex-basis=400px></p><p>点击第二个 Create New Project</p><p>回到上方，选择一个空文件夹</p><p>语言根据需要选，模型默认 V2, Python 环境可以选择有的也可以跳过</p><p>Template 选择 HTTP Trigger</p><p><img src=/p/231013-saas/img/Azure-01-create-02.jpg width=915 height=423 srcset="/p/231013-saas/img/Azure-01-create-02_hu15999404869120558981.jpg 480w, /p/231013-saas/img/Azure-01-create-02_hu18028118204848732928.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=216 data-flex-basis=519px></p><p>Trigger 名称是你的 API 路径，这里我改成了 <code>bot</code></p><p><img src=/p/231013-saas/img/Azure-01-create-03.jpg width=926 height=212 srcset="/p/231013-saas/img/Azure-01-create-03_hu3597380138964957097.jpg 480w, /p/231013-saas/img/Azure-01-create-03_hu5279610183412657730.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=436 data-flex-basis=1048px></p><p>然后认证选择 Anonymous</p><p><img src=/p/231013-saas/img/Azure-01-create-04.jpg width=917 height=220 srcset="/p/231013-saas/img/Azure-01-create-04_hu6484314636284106949.jpg 480w, /p/231013-saas/img/Azure-01-create-04_hu17372495125940310139.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=416 data-flex-basis=1000px></p><p>就可以打开生成的代码文件编辑了</p><h3 id=填入代码-1>填入代码</h3><p>首先这个 Create New Function 是没有用的</p><p><img src=/p/231013-saas/img/Azure-02-code-01.jpg width=515 height=317 srcset="/p/231013-saas/img/Azure-02-code-01_hu9783479323240039316.jpg 480w, /p/231013-saas/img/Azure-02-code-01_hu14571720173365351292.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=162 data-flex-basis=389px></p><p>它不过是在你的代码里加一个入口，可以自己写</p><p>把代码贴进去就好了，不赘叙</p><p>主函数示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=n>route</span><span class=o>=</span><span class=s2>&#34;bot&#34;</span><span class=p>,</span> <span class=n>auth_level</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>AuthLevel</span><span class=o>.</span><span class=n>ANONYMOUS</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>(</span><span class=n>req</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>req</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s2>&#34;POST&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;I am working!&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span> <span class=o>=</span> <span class=n>Update</span><span class=o>.</span><span class=n>de_json</span><span class=p>(</span><span class=n>req</span><span class=o>.</span><span class=n>get_json</span><span class=p>(),</span> <span class=n>bot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>update</span><span class=o>.</span><span class=n>inline_query</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>inline</span><span class=p>(</span><span class=n>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span> <span class=o>=</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>msg</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>id</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=n>nonsense_reply</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Unknown type. Ignoring...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>req</span><span class=o>.</span><span class=n>get_json</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span> <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>res</span><span class=p>)</span> <span class=ow>is</span> <span class=nb>str</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里要特别注意的是，
入口参数 <strong>必须是 <code>req</code></strong>，
如果不一致，部署后会找不到 HTTP Trigger!!!</p><p><img src=/p/231013-saas/img/Azure-02-code-02.jpg width=812 height=418 srcset="/p/231013-saas/img/Azure-02-code-02_hu9842958873405205206.jpg 480w, /p/231013-saas/img/Azure-02-code-02_hu8130371320945497883.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=194 data-flex-basis=466px></p><p>微软没有任何文档提到这一点！我是怎么发现的呢？</p><p>原先一直用的是 <code>request</code> 当入口，
因为一直部署失败，乱翻文档，在 <a class=link href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger#decorators target=_blank rel=noopener>HTTP Trigger</a> 看到这么一句</p><blockquote><p><code>trigger_arg_name</code> Argument name for HttpRequest, defaults to &lsquo;req&rsquo;.</p></blockquote><p>没事限制参数干嘛？我就改成 <code>req</code> 居然就成功了</p><h3 id=部署和设置>部署和设置</h3><p>工作区 Azure 图标 - Create Function App in Azure</p><p><img src=/p/231013-saas/img/Azure-03-deploy-01.jpg width=802 height=382 srcset="/p/231013-saas/img/Azure-03-deploy-01_hu17638285022885548730.jpg 480w, /p/231013-saas/img/Azure-03-deploy-01_hu13040705852259205592.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=209 data-flex-basis=503px></p><p>会需要你填写一个唯一的不重复的名字，因为这个到时候会写到 API 的 URL 里面</p><p>我这里用的是 <code>kmlt</code></p><p>然后选择环境和地区，完成和等待创建即可</p><p><img src=/p/231013-saas/img/Azure-03-deploy-02.jpg width=907 height=590 srcset="/p/231013-saas/img/Azure-03-deploy-02_hu4100003535497009105.jpg 480w, /p/231013-saas/img/Azure-03-deploy-02_hu18185481922857429473.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=153 data-flex-basis=368px></p><p><img src=/p/231013-saas/img/Azure-03-deploy-03.jpg width=908 height=587 srcset="/p/231013-saas/img/Azure-03-deploy-03_hu4367654215119332445.jpg 480w, /p/231013-saas/img/Azure-03-deploy-03_hu530919627314105340.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=154 data-flex-basis=371px></p><p>随后上方可见刚刚创建的 Function App</p><p><img src=/p/231013-saas/img/Azure-03-deploy-04.jpg width=457 height=294 srcset="/p/231013-saas/img/Azure-03-deploy-04_hu10400580843931513329.jpg 480w, /p/231013-saas/img/Azure-03-deploy-04_hu14060385532994401256.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=155 data-flex-basis=373px></p><hr><p>创建好，部署之前，
如果你有环境变量需要设置，
点开
Azure -
Resources -
Function App -
kmlt,
在 <strong><code>Application Settings</code></strong> 上右键，
在弹出窗口中分别填入环境变量的名字和值</p><p><img src=/p/231013-saas/img/Azure-03-deploy-05.jpg width=498 height=254 srcset="/p/231013-saas/img/Azure-03-deploy-05_hu4196718918291518455.jpg 480w, /p/231013-saas/img/Azure-03-deploy-05_hu8248565200556756468.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=196 data-flex-basis=470px></p><hr><p>完成后，点击 Functions 图标，选择
<strong>Deploy to Function App&mldr;</strong></p><p>上方选择刚创建的，
弹出警告点 Deploy</p><p>右下角会开始输出部署 log</p><p><img src=/p/231013-saas/img/Azure-03-deploy-06.jpg width=1088 height=482 srcset="/p/231013-saas/img/Azure-03-deploy-06_hu17316824194653060566.jpg 480w, /p/231013-saas/img/Azure-03-deploy-06_hu9666457840145064241.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=225 data-flex-basis=541px></p><h3 id=完成-2>完成</h3><p>完成后 log 会显示你的 Trigger URL</p><p><img src=/p/231013-saas/img/Azure-04-done-01.jpg width=1201 height=514 srcset="/p/231013-saas/img/Azure-04-done-01_hu8026111017383347434.jpg 480w, /p/231013-saas/img/Azure-04-done-01_hu12145447332319321265.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=233 data-flex-basis=560px></p><p>可以打开 URL 测试</p><p><img src=/p/231013-saas/img/Azure-04-done-02.jpg width=2560 height=1262 srcset="/p/231013-saas/img/Azure-04-done-02_hu6595772853017512192.jpg 480w, /p/231013-saas/img/Azure-04-done-02_hu4755855760353413493.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=202 data-flex-basis=486px></p><h2 id=总结>总结</h2><p>平心而论，
Azure 的部署过程其实是很方便的，
尤其是对于那些用惯了 VS Code 的人来说。</p><p>然而由于微软的文档过于语焉不详才让我吃了那么多苦头，
甚至没有这件事就没有这篇发奋而作的 blog，
笑死。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/guide/>Guide</a>
<a href=/tags/saas/>SaaS</a>
<a href=/tags/google/>Google</a>
<a href=/tags/amazon/>Amazon</a>
<a href=/tags/azure/>Azure</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/220623-nexmo/><div class=article-image><img src=/p/220623-nexmo/img/cover.9a5c44ed46dd6e2cefc630e6bc1e011c_hu13933009696578799344.jpg width=250 height=150 loading=lazy alt="Featured image of post Nexmo 虚拟手机号浅探" data-key=220623-nexmo data-hash="md5-mlxE7UbdbizvxjDmvB4BHA=="></div><div class=article-details><h2 class=article-title>Nexmo 虚拟手机号浅探</h2></div></a></article><article class=has-image><a href=/p/231204-rhel-lxc/><div class=article-image><img src=/p/231204-rhel-lxc/img/cover.d4d5c751f6f2d2376efec9914e8046c1_hu11340255609190943155.jpg width=250 height=150 loading=lazy alt="Featured image of post 制作 RHEL LXC 容器镜像" data-key=231204-rhel-lxc data-hash="md5-1NXHUfby0jdu/smRToBGwQ=="></div><div class=article-details><h2 class=article-title>制作 RHEL LXC 容器镜像</h2></div></a></article><article class=has-image><a href=/p/230718-modem-decrypt/><div class=article-image><img src=/p/230718-modem-decrypt/img/cover.8b7cc96a6fbdd9b4aa9af57a6717b0b8_hu3898490877054706318.jpg width=250 height=150 loading=lazy alt="Featured image of post 诺基亚贝尔光猫宽带密码破解提取" data-key=230718-modem-decrypt data-hash="md5-i3zJam+92bSqmvV6ZxewuA=="></div><div class=article-details><h2 class=article-title>诺基亚贝尔光猫宽带密码破解提取</h2></div></a></article><article class=has-image><a href=/p/230617-apple-pay/><div class=article-image><img src=/p/230617-apple-pay/img/err-invalid.c271f62475a3b3c34dda6e5a8ffae6df_hu14285095540309688136.jpg width=250 height=150 loading=lazy alt="Featured image of post Apple Pay 绑卡失败原因速查" data-key=230617-apple-pay data-hash="md5-wnH2JHWjs8NN2m5aj/rm3w=="></div><div class=article-details><h2 class=article-title>Apple Pay 绑卡失败原因速查</h2></div></a></article><article class=has-image><a href=/p/221227-pve-openwrt/><div class=article-image><img src=/p/221227-pve-openwrt/img/cover.a14de8c6d6b26ca4792b753f58493704_hu1321247466967423932.jpg width=250 height=150 loading=lazy alt="Featured image of post PVE 更新 OpenWrt 教程" data-key=221227-pve-openwrt data-hash="md5-oU3oxtaybKR5K3U/WEk3BA=="></div><div class=article-details><h2 class=article-title>PVE 更新 OpenWrt 教程</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//kumatea.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2025 酷玛阁 | KumaTea's Blog</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.27.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>